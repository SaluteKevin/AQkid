<template>
    <div class="h-screen justify-end place-item-center flex overflow-hidden">
        <div class="relative w-full grid grid-cols-2 md:grid-cols-4 gap-4 p-2 bg-gradient-to-br from-indigo-700 via-cyan-400 to-orange-300">
            <div class="bg-gray-200 bg-opacity-80 absolute inset-0 w-2/3 h-2/3 mx-auto my-auto overflow-y-auto">
                <img src="/images/AQKids_logo.png" class="w-32 h-32 mx-auto mt-16">
                <div class="text-center font-semibold  mt-4">
                    <span class="text-orange-500 text-4xl">Aquakids</span> <span class="text-cyan-950 text-4xl">Chiangmai</span>
                    <br>
                    <br>
                    <span class="text-xl">เงื่อนไขการลงสมัคร</span>
                    <br><br>
                    ช่องข้อมูลที่มีสัญลักษณ์ "<span class="text-red-500">***</span>" คือข้อมูลที่ต้องกรอก
                    <br>
                    ช่องอื่นๆ ท่านสามารถใส่ได้ตามความจำเป็น

                    <br>
                    <span class="text-gray-500">------------------------------</span>
                    <br>
                    <span class="text-xl">Register Condition</span>
                    <br><br>
                    The data fields with "<span class="text-red-500">***</span>" are needed infomation
                    <br>
                    the other is optionally
                </div>
            </div>
            <div class="grid gap-4">
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160601509956964523/258397402_4855220244508897_4255804475468976414_n.png?ex=65354162&is=6522cc62&hm=df137a62cd0fd39554caaf30612bf8284415391b3235fe79d1de7ebb82e9efeb&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://media.discordapp.net/attachments/1077532767052628008/1160566038790930463/325365077_3106200752859494_8093093560058923555_n.png?ex=65352059&is=6522ab59&hm=c87dac154c23bd6ca85edb4dc21b8bf02daef4e1cd69476d25b0aeec7ff695b9&=&width=1182&height=735" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/1077532767052628008/1160566613704187994/118541314_1740879556082991_2163170739582168072_n.png?ex=653520e2&is=6522abe2&hm=8d7717633a76684b7632eafd0affe314be59d1c3896dfeeb7741a6b0c19839b1&" alt="">
                </div>
            </div>
            <div class="grid gap-4">
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160596548346990632/361185793_738987691571314_899847787237408274_n.png?ex=65353cc3&is=6522c7c3&hm=59e9ba8f8216e9ea2c98517d91d0718f8ed444a1276d21262d552c081b38baf9&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160600865963524160/271933448_5564275880254766_1832002438206814920_n.png?ex=653540c9&is=6522cbc9&hm=a8e7e64b0ce7725b7f6ece79df289863814adb07591cef9e2fc04aa8cbd7a8b6&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160600807801102396/271903862_10159688540849376_8948354250851847496_n.png?ex=653540bb&is=6522cbbb&hm=71d04246d3bec025772cdf98a0db7af644fe36cef18591b9b9786d9791c12225&" alt="">
                </div>
            </div>
            <div class="grid gap-4">
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160598734435000320/361648744_738993304904086_5497916127488969777_n.jpg?ex=65353ecd&is=6522c9cd&hm=f40ddd518cda5b4e57d4151e11a931e8b1b228434af310d54725a7ab08979f4e&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160597040829583481/354233673_713421017461315_3218277473228969050_n.png?ex=65353d39&is=6522c839&hm=b23adbca1a8abef24f7735c92454bce3d23e1a92f946566b96d15e7fb942cef9&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160601117944721428/267627553_10158582063122944_8390153846949698207_n.png?ex=65354105&is=6522cc05&hm=9638819f32cd20923eb15c737bae1304dbd0284c5bfa8e3a72cd2fe15118ad0f&" alt="">
                </div>
            </div>
            <div class="grid gap-4">
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160594887499071538/362288650_738993328237417_988681206543655468_n.jpg?ex=65353b37&is=6522c637&hm=e1f314f86f5041931f188565534dc6b9e6d8f1b09a97fe6c9012c1d7db2d0132&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160601184021774356/270038517_4687873974660638_9097962751416104999_n.png?ex=65354115&is=6522cc15&hm=ce863532f12c69c9f5027aadab81cba8f35b551545916cefd8172bbeb4b92497&" alt="">
                </div>
                <div>
                    <img class="h-full w-auto rounded-lg object-cover border-2 shadow-2xl" src="https://cdn.discordapp.com/attachments/871313414616657920/1160601681864700036/258544317_1590498887960348_1140566917094527056_n.png?ex=6535418b&is=6522cc8b&hm=1cbb5f26166af5f461b824d22381f9c1fc26be5b91ac504cd6498c16e8c83f75&" alt="">
                </div>
            </div>
        </div>         
        <div class="overflow-y-auto bg-native w-full rounded-l-xl p-16 shadow-2xl">
                <form @submit.prevent="handleRegister()">
                <h1 class="text-4xl decoration-indigo-500 text-center mt-4 text-gray-800 font-semibold">Sign up</h1>
                    <div class="relative flex py-5 items-center w-full px-10">
                            <div class="flex-grow border-t border-gray-400"></div>
                            <span class="flex-shrink mx-4 text-gray-400">Account Section</span>
                            <div class="flex-grow border-t border-gray-400"></div>
                        </div>
                        <label for="username" class="flex">Username <span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.username"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded  "
                            name="username"
                            placeholder="Username" id="username"/>
                        <p class="text-red-500" v-for="error in RegistrationError['username']" :key="error">
                                    {{ error }}
                        </p>

                        <label for="email" class="flex mt-4">Email</label>
                        <input v-model="RegistrationForm.email"
                            type="email"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="email"
                            placeholder="Email (Optional)" 
                            id="email"/>
                            <p class="text-red-500" v-for="error in RegistrationError['email']" :key="error">
                                    {{ error }}
                            </p>

                        <label for="password" class="flex mt-4">Password <span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.password"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="password"
                            placeholder="Password" 
                            id="password"/>
                        
                        <p class="text-red-500" v-for="error in RegistrationError['password']" :key="error">
                                    {{ error }}
                        </p>
                        
                        <label for="password_confirmation" class="flex mt-4">Confirm Password <span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.password_confirmation"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="password_confirmation"
                            placeholder="Confirm Password" 
                            id="password_confirmation"/>

                        <div class="relative flex py-5 items-center w-full px-10">
                            <div class="flex-grow border-t border-gray-400"></div>
                            <span class="flex-shrink mx-4 text-gray-400">Info Section</span>
                            <div class="flex-grow border-t border-gray-400"></div>
                        </div>
                        
                        <label for="firstname" class="flex mt-4">Firstname<span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.firstname"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="firstname"
                            placeholder="Firstname" 
                            id="firstname"/>

                        <p class="text-red-500" v-for="error in RegistrationError['firstname']" :key="error">
                                    {{ error }}
                        </p>

                        <label for="middlename" class="flex mt-4">Middlename</label>
                        <input v-model="RegistrationForm.middlename"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="middlename"
                            placeholder="Middlename" 
                            id="middlename"/>

                        <p class="text-red-500" v-for="error in RegistrationError['middlename']" :key="error">
                                    {{ error }}
                        </p>

                        <label for="lastname" class="flex mt-4">Lastname<span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.lastname"
                            type="text"
                            class="block border border-grey-light w-full p-3 rounded"
                            name="lastname"
                            placeholder="Lastname" 
                            id="lastname"/>
                        
                        <p class="text-red-500" v-for="error in RegistrationError['lastname']" :key="error">
                                    {{ error }}
                        </p>

                        <label for="birthdate" class="flex mt-4">Birthdate<span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.birthdate"
                        type="date" id="birthdate" name="birthdate"
                        class="block border border-grey-light w-full p-3 rounded">
                        <p class="text-red-500" v-for="error in RegistrationError['birthdate']" :key="error">
                                    {{ error }}
                        </p>
                            
                        <label for="phone_number" class="flex mt-4">Phone Number<span class="text-red-500 mt-1 ml-2">  ***</span></label>
                        <input v-model="RegistrationForm.phone_number"
                        type="tel" id="phone_number" name="phone_number" placeholder="081-111-1111" 
                        class="block border border-grey-light w-full p-3 rounded">

                        <p class="text-red-500" v-for="error in RegistrationError['phone_number']" :key="error">
                                    {{ error }}
                        </p>

                        <!-- image -->

                        <label for="profile_image" class="flex mt-4">Profile Image</label>

                        <div class="flex w-full gap-5">
                            <input @change="handleImageChange" ref="profileImageInput" id="profile_image" name="profile_image" class='inline-flex items-center shadow-md my-2 px-2 py-2 bg-gray-900 text-gray-50 border border-transparent
                                rounded-md font-semibold text-xs uppercase tracking-widest hover:bg-gray-700 active:bg-gray-900 focus:outline-none 
                            focus:border-gray-900 focus:ring ring-gray-300 disabled:opacity-25 transition ease-in-out duration-150' type="file">
                            <button @click="removeImagePreview"
                            class = 'inline-flex items-center shadow-md my-2 px-2 py-2 bg-gray-900 text-gray-50 border border-transparent
                                rounded-md font-semibold text-xs uppercase tracking-widest hover:bg-gray-700 active:bg-gray-900 focus:outline-none 
                            focus:border-gray-900 focus:ring ring-gray-300 disabled:opacity-25 transition ease-in-out duration-150'>
                            remove image
                            </button>


                        </div>
                        

                        

                            <div 
                                class="relative order-first md:order-last h-28 md:h-auto flex justify-center items-center border border-dashed border-gray-400 col-span-2 m-2 rounded-lg bg-no-repeat bg-center bg-origin-padding bg-cover">
                                    <span v-if="imagefix" class="text-gray-400 opacity-75">
                                        <svg class="w-14 h-14"  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="0.7" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                    </svg>
                                    </span>
                                    
                                    <img ref="imagePreview" :src="imagePreviewSrc" alt="">
                            </div>

            

                        

                        <button
                            type="submit"
                            class="bg-black mt-8
                                shadow-inner 
                                hover:shadow-xl duration-300 hover:bg-white hover:text-indigo-600 w-full text-center py-3 rounded text-white my-1"
                        >Create Account</button>

                        <p class="text-red-500" v-for="error in RegistrationError['message']" :key="error">
                                    {{ error }}
                        </p>

                        <div class="text-grey-dark">
                        Already Sign Up? 
                        <NuxtLink class="no-underline border-b border-blue text-indigo-600" to="/auths/login">
                            Log in
                        </NuxtLink>

                    </div>
                </form>
        </div>
    </div>
</template>


<script setup lang="ts">
definePageMeta({layout: false})

import {useAuthStore} from "~/stores/useAuthStore";
    
const auth = useAuthStore();

await auth.setCSRFCookie();

const RegistrationForm = ref({
    username: "",
    email: "",
    password: "",
    password_confirmation: "",
    firstname: "",
    middlename: "",
    lastname: "",
    birthdate:"",
    phone_number:"",
    
});

const RegistrationError = ref<{ [k: string]: any }>({})

const profile_image_path =  ref<File | null>(null)


async function handleRegister() {

    const formData = new FormData()

    if (profile_image_path.value) {
        formData.append('profile_image_path', profile_image_path.value)
    }

    for (const item in RegistrationForm.value) {
        formData.append(item, RegistrationForm.value[item]);
    }

    const {data: registerResponse, error: registerError } = await useApiFetch("api/auth/register", {
            method: "POST",
            body: formData,
    });

    if (registerResponse.value) {

        await navigateTo(`/auths/login`);

    } 

    else {

        if (registerError.value) {

            
            const errors = registerError.value.data.errors;

            RegistrationError.value = {};

            for (const key in errors) {

                if (errors.hasOwnProperty(key)) {

                const errorMessages = errors[key];
                
                RegistrationError.value[key] = errorMessages;

                }
            }
            

        }

    }   


}



// image preview
const profileImageInput = ref<HTMLInputElement | null>(null);
const imagePreview = ref<HTMLImageElement | null>(null);
const imagePreviewSrc = ref<string>(''); // Store the image source
const imagefix = ref(true);

const handleImageChange = () => {
  if (profileImageInput.value && profileImageInput.value.files && profileImageInput.value.files[0]) {
    const selectedFile = profileImageInput.value.files[0];
    const reader = new FileReader();

    reader.onload = (event: ProgressEvent<FileReader>) => {
      if (imagePreview.value) {
        imagePreview.value.src = event.target?.result as string;
        imagePreviewSrc.value = event.target?.result as string; // Set the image source
        imagefix.value = false;
        profile_image_path.value = selectedFile;
      }
    };

    reader.readAsDataURL(selectedFile);
  } else {
    // Handle the case when no file is selected or the selection is canceled
    if (imagePreview.value) {
      imagePreview.value.src = '';
      imagePreviewSrc.value = ''; // Clear the image source
      imagefix.value = true;
      profile_image_path.value = null;
    }
  }
};

const removeImagePreview = () => {
  if (imagePreview.value) {
    imagePreview.value.src = '';
    imagePreviewSrc.value = ''; // Clear the image source
    imagefix.value = true;
    profile_image_path.value = null;
  }

  if (profileImageInput.value) {
    profileImageInput.value.value = ''; // Clear the input value
  }
};


</script>